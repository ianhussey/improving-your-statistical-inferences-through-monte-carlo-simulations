<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; Mapping over functions – Improving your statistical inferences through Monte Carlo simulations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/7_summarizing_results.html" rel="next">
<link href="../chapters/5_creating_simulation_experiments.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/6_mapping.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping over functions</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Improving your statistical inferences through Monte Carlo simulations</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/1_foundation_concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Foundation concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/2_writing_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Writing functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/3_data_generating_process_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data generating processes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/4_analysis_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Analysis functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/5_creating_simulation_experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Creating simulation experiments</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/6_mapping.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping over functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/7_summarizing_results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Summarizing results</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/8_planning_and_reporting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Planning and reporting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/9_simulation_template.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simulation template</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/violating_assumptions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Assessing the impact of violating the assumption of normality</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/testing_assumptions_and_conditional_tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">The statistical power of assumptions tests and the conditional use of (non-)parameteric tests”</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/p_hacking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">p-hacking via different forms of selecting reporting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/p_values_and_confidence_intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Understanding the link between p-values, Confidence Intervals, and power</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/difference_between_signfiicant_and_nonsignificant.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">The differences between significant and non-significant is not itself significant</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/standardized_effect_sizes_and_range_restriction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Standardized effect sizes and range restriction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/impact_of_lazy_responding_assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The impact of one form of lazy/careless responding on the power and false positive rate of a Student’s t-test</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/meta_analysis_and_publication_bias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Meta-analysis and publication bias</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/causality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Regression assumes causality</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/license.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">License and citation</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview-of-tutorial" id="toc-overview-of-tutorial" class="nav-link active" data-scroll-target="#overview-of-tutorial"><span class="header-section-number">6.1</span> Overview of tutorial</a></li>
  <li><a href="#dependencies" id="toc-dependencies" class="nav-link" data-scroll-target="#dependencies"><span class="header-section-number">6.2</span> Dependencies</a></li>
  <li><a href="#recap-generate-and-analyze-functions" id="toc-recap-generate-and-analyze-functions" class="nav-link" data-scroll-target="#recap-generate-and-analyze-functions"><span class="header-section-number">6.3</span> <strong>Recap: generate and analyze functions</strong></a></li>
  <li><a href="#doing-it-once" id="toc-doing-it-once" class="nav-link" data-scroll-target="#doing-it-once"><span class="header-section-number">6.4</span> <strong>Doing it once</strong></a></li>
  <li><a href="#why-copypaste-is-the-enemy" id="toc-why-copypaste-is-the-enemy" class="nav-link" data-scroll-target="#why-copypaste-is-the-enemy"><span class="header-section-number">6.5</span> <strong>Why copy–paste is the enemy</strong></a></li>
  <li><a href="#the-core-idea-of-mapping" id="toc-the-core-idea-of-mapping" class="nav-link" data-scroll-target="#the-core-idea-of-mapping"><span class="header-section-number">6.6</span> <strong>The core idea of mapping</strong></a>
  <ul class="collapse">
  <li><a href="#map-repeats-a-function-over-a-vectorlist" id="toc-map-repeats-a-function-over-a-vectorlist" class="nav-link" data-scroll-target="#map-repeats-a-function-over-a-vectorlist"><span class="header-section-number">6.6.1</span> <strong>map() repeats a function over a vector/list</strong></a></li>
  <li><a href="#the-anonymous-function-shorthand" id="toc-the-anonymous-function-shorthand" class="nav-link" data-scroll-target="#the-anonymous-function-shorthand"><span class="header-section-number">6.6.2</span> <strong>The anonymous-function shorthand: <code>~</code></strong></a></li>
  </ul></li>
  <li><a href="#a-first-simulation-with-map" id="toc-a-first-simulation-with-map" class="nav-link" data-scroll-target="#a-first-simulation-with-map"><span class="header-section-number">6.7</span> <strong>A first simulation with map()</strong></a>
  <ul class="collapse">
  <li><a href="#map-over-iterations" id="toc-map-over-iterations" class="nav-link" data-scroll-target="#map-over-iterations"><span class="header-section-number">6.7.1</span> <strong>Map over iterations</strong></a></li>
  <li><a href="#extract-one-element" id="toc-extract-one-element" class="nav-link" data-scroll-target="#extract-one-element"><span class="header-section-number">6.7.2</span> <strong>Extract one element</strong></a></li>
  </ul></li>
  <li><a href="#turning-a-list-into-a-tidy-tibble" id="toc-turning-a-list-into-a-tidy-tibble" class="nav-link" data-scroll-target="#turning-a-list-into-a-tidy-tibble"><span class="header-section-number">6.8</span> <strong>Turning a list into a tidy tibble</strong></a>
  <ul class="collapse">
  <li><a href="#add-the-iteration-number" id="toc-add-the-iteration-number" class="nav-link" data-scroll-target="#add-the-iteration-number"><span class="header-section-number">6.8.1</span> <strong>Add the iteration number</strong></a></li>
  </ul></li>
  <li><a href="#another-map_-variant" id="toc-another-map_-variant" class="nav-link" data-scroll-target="#another-map_-variant"><span class="header-section-number">6.9</span> <strong>Another map_*() variant</strong></a>
  <ul class="collapse">
  <li><a href="#map_dbl-returns-a-numeric-vector" id="toc-map_dbl-returns-a-numeric-vector" class="nav-link" data-scroll-target="#map_dbl-returns-a-numeric-vector"><span class="header-section-number">6.9.1</span> <strong><code>map_dbl()</code> returns a numeric vector</strong></a></li>
  </ul></li>
  <li><a href="#null-vs-alternative-using-mapping" id="toc-null-vs-alternative-using-mapping" class="nav-link" data-scroll-target="#null-vs-alternative-using-mapping"><span class="header-section-number">6.10</span> <strong>Null vs alternative using mapping</strong></a>
  <ul class="collapse">
  <li><a href="#use-map2-to-map-multple-parameters-at-once" id="toc-use-map2-to-map-multple-parameters-at-once" class="nav-link" data-scroll-target="#use-map2-to-map-multple-parameters-at-once"><span class="header-section-number">6.10.1</span> <strong>Use <code>map2()</code> to map multple parameters at once</strong></a></li>
  <li><a href="#plot-distribution-of-p-values-for-both-conditions" id="toc-plot-distribution-of-p-values-for-both-conditions" class="nav-link" data-scroll-target="#plot-distribution-of-p-values-for-both-conditions"><span class="header-section-number">6.10.2</span> Plot distribution of p-values for both conditions</a></li>
  </ul></li>
  <li><a href="#creating-parameter-grids-more-effectively-expand_grid" id="toc-creating-parameter-grids-more-effectively-expand_grid" class="nav-link" data-scroll-target="#creating-parameter-grids-more-effectively-expand_grid"><span class="header-section-number">6.11</span> <strong>Creating parameter grids more effectively:</strong> <code>expand_grid()</code></a></li>
  <li><a href="#mapping-with-multiple-inputs-pmap" id="toc-mapping-with-multiple-inputs-pmap" class="nav-link" data-scroll-target="#mapping-with-multiple-inputs-pmap"><span class="header-section-number">6.12</span> <strong>Mapping with multiple inputs: <code>pmap()</code></strong></a></li>
  <li><a href="#pmap-for-parameter-sweeps" id="toc-pmap-for-parameter-sweeps" class="nav-link" data-scroll-target="#pmap-for-parameter-sweeps"><span class="header-section-number">6.13</span> <strong><code>pmap()</code> for parameter sweeps</strong></a>
  <ul class="collapse">
  <li><a href="#specify-the-parameter-grid" id="toc-specify-the-parameter-grid" class="nav-link" data-scroll-target="#specify-the-parameter-grid"><span class="header-section-number">6.13.1</span> Specify the parameter grid</a></li>
  <li><a href="#run-the-simulations" id="toc-run-the-simulations" class="nav-link" data-scroll-target="#run-the-simulations"><span class="header-section-number">6.13.2</span> Run the simulations</a></li>
  <li><a href="#get-results-per-parameter-combination" id="toc-get-results-per-parameter-combination" class="nav-link" data-scroll-target="#get-results-per-parameter-combination"><span class="header-section-number">6.13.3</span> Get results per parameter combination</a></li>
  </ul></li>
  <li><a href="#nested-data-frames-list-columns-are-useful" id="toc-nested-data-frames-list-columns-are-useful" class="nav-link" data-scroll-target="#nested-data-frames-list-columns-are-useful"><span class="header-section-number">6.14</span> <strong>Nested data frames (list-columns) are useful</strong></a></li>
  <li><a href="#parallel-mapping-with-furrr" id="toc-parallel-mapping-with-furrr" class="nav-link" data-scroll-target="#parallel-mapping-with-furrr"><span class="header-section-number">6.15</span> <strong>Parallel mapping with {furrr}</strong></a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">6.16</span> <strong>Summary</strong></a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">6.17</span> <strong>Exercises</strong></a>
  <ul class="collapse">
  <li><a href="#warm-up-map-a-simple-function" id="toc-warm-up-map-a-simple-function" class="nav-link" data-scroll-target="#warm-up-map-a-simple-function"><span class="header-section-number">6.17.1</span> <strong>Warm-up: map a simple function</strong></a></li>
  <li><a href="#map-a-simulation-200-times" id="toc-map-a-simulation-200-times" class="nav-link" data-scroll-target="#map-a-simulation-200-times"><span class="header-section-number">6.17.2</span> <strong>Map a simulation 200 times</strong></a></li>
  <li><a href="#extract-a-numeric-vector-of-p-values" id="toc-extract-a-numeric-vector-of-p-values" class="nav-link" data-scroll-target="#extract-a-numeric-vector-of-p-values"><span class="header-section-number">6.17.3</span> <strong>Extract a numeric vector of p-values</strong></a></li>
  <li><a href="#make-a-tiny-experiment-with-expand_grid-pmap" id="toc-make-a-tiny-experiment-with-expand_grid-pmap" class="nav-link" data-scroll-target="#make-a-tiny-experiment-with-expand_grid-pmap"><span class="header-section-number">6.17.4</span> <strong>Make a tiny experiment with expand_grid() + pmap()</strong></a></li>
  <li><a href="#optional-parallelize" id="toc-optional-parallelize" class="nav-link" data-scroll-target="#optional-parallelize"><span class="header-section-number">6.17.5</span> <strong>(Optional) Parallelize</strong></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping over functions</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview-of-tutorial" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="overview-of-tutorial"><span class="header-section-number">6.1</span> Overview of tutorial</h2>
<p>In the last lesson, you wrote a data-generation function (<code>generate_data()</code>) and an analysis function (<code>analyze()</code>), then called them once with the pipe:</p>
<ul>
<li>generate one dataset<br>
</li>
<li>analyze it<br>
</li>
<li>get a result (e.g., one <em>p</em>-value)</li>
</ul>
<p>A simulation study is just doing that many times, and then summarizing the results.</p>
<p>The big question for this lesson:</p>
<p>How do we repeat the same “generate → analyze” workflow lots of times, without copy–pasting code?</p>
<p>Answer: <strong>mapping</strong>. In the tidyverse, this is usually done with the <code>{purrr}</code> package (and, later, <code>{furrr}</code> for parallel processing).</p>
<p>By the end of this chapter, you should be able to:</p>
<ul>
<li>Use <code>map()</code> to repeat a simulation many times.</li>
<li>Use <code>map_dbl()</code> / <code>map_int()</code> / <code>map_chr()</code> to get clean vectors out.</li>
<li>Use <code>map_dfr()</code> to bind outputs into a tibble.</li>
<li>Use <code>map2()</code> and <code>pmap()</code> to run parameter sweeps.</li>
<li>Understand what it means when mapping produces nested data frames (list-columns).</li>
<li>Use <code>future_map()</code> / <code>future_pmap()</code> (from <code>{furrr}</code>) when you want to parallelize.</li>
</ul>
</section>
<section id="dependencies" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="dependencies"><span class="header-section-number">6.2</span> Dependencies</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set up parallelization (we will use this later in the chapter)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="recap-generate-and-analyze-functions" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="recap-generate-and-analyze-functions"><span class="header-section-number">6.3</span> <strong>Recap: generate and analyze functions</strong></h2>
<p>Here is the same example setup you saw earlier: two conditions (control vs intervention), normally distributed scores, and a two-sample <em>t</em>-test.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(n_per_condition,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                          mean_control,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                          mean_intervention,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                          sd) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  data_control <span class="ot">&lt;-</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">condition =</span> <span class="st">"control"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">score =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_per_condition, <span class="at">mean =</span> mean_control, <span class="at">sd =</span> sd))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  data_intervention <span class="ot">&lt;-</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">condition =</span> <span class="st">"intervention"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">score =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_per_condition, <span class="at">mean =</span> mean_intervention, <span class="at">sd =</span> sd))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  data_combined <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data_control, data_intervention)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_combined)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>analyze <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  res_t_test <span class="ot">&lt;-</span> <span class="fu">t.test</span>(<span class="at">formula =</span> score <span class="sc">~</span> condition,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> data,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var.equal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alternative =</span> <span class="st">"two.sided"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> res_t_test<span class="sc">$</span>p.value)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="doing-it-once" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="doing-it-once"><span class="header-section-number">6.4</span> <strong>Doing it once</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze</span>()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0142</code></pre>
</div>
</div>
</section>
<section id="why-copypaste-is-the-enemy" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="why-copypaste-is-the-enemy"><span class="header-section-number">6.5</span> <strong>Why copy–paste is the enemy</strong></h2>
<p>You already saw the “bad” way: calling the same code block over and over and binding it with bind_rows().</p>
<p>This is bad because:</p>
<ul>
<li><p>It’s slow to write and easy to make mistakes.</p></li>
<li><p>It’s hard to scale from 25 iterations to 10,000 iterations.</p></li>
<li><p>It’s hard to turn into a proper experiment (varying parameters systematically).</p></li>
</ul>
<p>So: we need a principled way to repeat the same computation. To do this, we can use the “<code>map()</code>” family of functions in R.</p>
</section>
<section id="the-core-idea-of-mapping" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="the-core-idea-of-mapping"><span class="header-section-number">6.6</span> <strong>The core idea of mapping</strong></h2>
<section id="map-repeats-a-function-over-a-vectorlist" class="level3" data-number="6.6.1">
<h3 data-number="6.6.1" class="anchored" data-anchor-id="map-repeats-a-function-over-a-vectorlist"><span class="header-section-number">6.6.1</span> <strong>map() repeats a function over a vector/list</strong></h3>
<p>purrr::map() takes:</p>
<ul>
<li><p>a vector/list of inputs (.x)</p></li>
<li><p>a function (.f)</p>
<p>and returns a <strong>list of outputs</strong> (always a list).</p></li>
</ul>
<p>Let’s look at a simple example. Imagine we have a vector of numbers (from 1 to 4) and, for each number, we want to add 10. We can use <code>map()</code> to do this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>numbers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(numbers, <span class="sc">~</span> .x <span class="sc">+</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 12

[[3]]
[1] 13

[[4]]
[1] 14</code></pre>
</div>
</div>
<p>Notice the output is a list, even though each element is just a number. This is on purpose: returning a list is the “safest” default, because in real work you might return complicated objects (models, data frames, plots…) and lists handle these diverse objects most effectively, and prevent errors from arising.</p>
</section>
<section id="the-anonymous-function-shorthand" class="level3" data-number="6.6.2">
<h3 data-number="6.6.2" class="anchored" data-anchor-id="the-anonymous-function-shorthand"><span class="header-section-number">6.6.2</span> <strong>The anonymous-function shorthand: <code>~</code></strong></h3>
<p>When you look at the example above, you might be wondering: what is the <strong><code>~</code></strong> symbol, and what is it doing? This is referred to as the <strong>anonymous-function (lambda) shorthand</strong> in {purrr} formula syntax. This lets you define a short function within the <code>map()</code> family of functions. In the case above, our function was “add 10 to the input”, where .x stands for the current input.</p>
<p>More concretely, the two lines of code below are equivalent:</p>
<p>Line 1:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(numbers, <span class="cf">function</span>(x) x <span class="sc">+</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 12

[[3]]
[1] 13

[[4]]
[1] 14</code></pre>
</div>
</div>
<p>Line 2:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(numbers, <span class="sc">~</span> .x <span class="sc">+</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 12

[[3]]
[1] 13

[[4]]
[1] 14</code></pre>
</div>
</div>
<p>You’ll see the ~ .x style constantly in tidyverse simulation code.</p>
</section>
</section>
<section id="a-first-simulation-with-map" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="a-first-simulation-with-map"><span class="header-section-number">6.7</span> <strong>A first simulation with map()</strong></h2>
<section id="map-over-iterations" class="level3" data-number="6.7.1">
<h3 data-number="6.7.1" class="anchored" data-anchor-id="map-over-iterations"><span class="header-section-number">6.7.1</span> <strong>Map over iterations</strong></h3>
<p>Ideally, simulations need an iteration index, which tells us what “round” of the simulation a given set of outputs are part of. We can often define these iterations simply, like:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>iterations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
</div>
</div>
<p>Now we map over iterations. For now, the iteration number doesn’t do anything - we just need to supply <code>map()</code> with a set of values to run across.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>simulation_results_list <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>simulation_results_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 1 × 1
          p
      &lt;dbl&gt;
1 0.0000630

[[2]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0696

[[3]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0293

[[4]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00196

[[5]]
# A tibble: 1 × 1
      p
  &lt;dbl&gt;
1 0.161

[[6]]
# A tibble: 1 × 1
         p
     &lt;dbl&gt;
1 0.000848

[[7]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0355

[[8]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0577

[[9]]
# A tibble: 1 × 1
          p
      &lt;dbl&gt;
1 0.0000181

[[10]]
# A tibble: 1 × 1
      p
  &lt;dbl&gt;
1 0.160</code></pre>
</div>
</div>
<p>You should see a list of tibbles, each tibble containing one <em>p</em>-value.</p>
<p>If we change the number of iterations, then the number of times <code>map()</code> is called will change:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>iterations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>simulation_results_list <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>simulation_results_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0192

[[2]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0812

[[3]]
# A tibble: 1 × 1
         p
     &lt;dbl&gt;
1 0.000271

[[4]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0589

[[5]]
# A tibble: 1 × 1
         p
     &lt;dbl&gt;
1 0.000783

[[6]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0377

[[7]]
# A tibble: 1 × 1
      p
  &lt;dbl&gt;
1 0.165

[[8]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0193

[[9]]
# A tibble: 1 × 1
         p
     &lt;dbl&gt;
1 0.000193

[[10]]
# A tibble: 1 × 1
         p
     &lt;dbl&gt;
1 0.000409

[[11]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0974

[[12]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00975

[[13]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00609

[[14]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00398

[[15]]
# A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0137

[[16]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00519

[[17]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00882

[[18]]
# A tibble: 1 × 1
        p
    &lt;dbl&gt;
1 0.00211

[[19]]
# A tibble: 1 × 1
         p
     &lt;dbl&gt;
1 0.000601

[[20]]
# A tibble: 1 × 1
      p
  &lt;dbl&gt;
1 0.972</code></pre>
</div>
</div>
</section>
<section id="extract-one-element" class="level3" data-number="6.7.2">
<h3 data-number="6.7.2" class="anchored" data-anchor-id="extract-one-element"><span class="header-section-number">6.7.2</span> <strong>Extract one element</strong></h3>
<p>Elements from the list output of <code>map()</code> are accessed with [[ ]]. For example, if we want the output of the first iteration, we can do this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>simulation_results_list[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
       p
   &lt;dbl&gt;
1 0.0192</code></pre>
</div>
</div>
</section>
</section>
<section id="turning-a-list-into-a-tidy-tibble" class="level2" data-number="6.8">
<h2 data-number="6.8" class="anchored" data-anchor-id="turning-a-list-into-a-tidy-tibble"><span class="header-section-number">6.8</span> <strong>Turning a list into a tidy tibble</strong></h2>
<p>Even though lists are helpful for preventing errors, we ideally would prefer the output to be in a tidy format, like a dataframe or a tibble, since this is easier to work with later. To get this type of tidier output, we can use the <code>map_dfr()</code> function, which returns dataframes as output instead of lists.</p>
<p>If each iteration returns a tibble with the same columns (in our case, a single column called p), map_dfr() will map and then bind the outputs together into a single dataframe.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>simulation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 1
           p
       &lt;dbl&gt;
 1 0.0763   
 2 0.0000388
 3 0.0150   
 4 0.000156 
 5 0.175    
 6 0.0875   
 7 0.0953   
 8 0.00704  
 9 0.282    
10 0.411    
11 0.236    
12 0.0290   
13 0.147    
14 0.288    
15 0.0797   
16 0.00219  
17 0.0332   
18 0.0000389
19 0.0165   
20 0.0116   </code></pre>
</div>
</div>
<p>As you can see, now simulation_results is a single tibble, not a list.</p>
<section id="add-the-iteration-number" class="level3" data-number="6.8.1">
<h3 data-number="6.8.1" class="anchored" data-anchor-id="add-the-iteration-number"><span class="header-section-number">6.8.1</span> <strong>Add the iteration number</strong></h3>
<p>When we look at the nice output above from <code>map_dfr</code>, we’re missing one important piece of information: the iteration number! As we said above, we ideally want to keep this number so we know what result belongs to what step of the simulation.</p>
<p>We can do this by going back to the original <code>map()</code> function with some small additions. Specifically:</p>
<ol type="1">
<li>We create a tibble with a single column, called iteration (or whatever we want), and assign this a vector of values from 1 to the number of iterations we want. For example, if we want 20 iterations:</li>
</ol>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 1
   iteration
       &lt;int&gt;
 1         1
 2         2
 3         3
 4         4
 5         5
 6         6
 7         7
 8         8
 9         9
10        10
11        11
12        12
13        13
14        14
15        15
16        16
17        17
18        18
19        19
20        20</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>We mutate a new column into this new tibble, called results (or whatever we want to call it). Then we run <code>map()</code> within the <code>mutate()</code> call using the iteration column and our <code>generate_data()</code> and <code>analyze()</code> functions, like this:</li>
</ol>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>simulation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 2
   iteration results         
       &lt;int&gt; &lt;list&gt;          
 1         1 &lt;tibble [1 × 1]&gt;
 2         2 &lt;tibble [1 × 1]&gt;
 3         3 &lt;tibble [1 × 1]&gt;
 4         4 &lt;tibble [1 × 1]&gt;
 5         5 &lt;tibble [1 × 1]&gt;
 6         6 &lt;tibble [1 × 1]&gt;
 7         7 &lt;tibble [1 × 1]&gt;
 8         8 &lt;tibble [1 × 1]&gt;
 9         9 &lt;tibble [1 × 1]&gt;
10        10 &lt;tibble [1 × 1]&gt;
11        11 &lt;tibble [1 × 1]&gt;
12        12 &lt;tibble [1 × 1]&gt;
13        13 &lt;tibble [1 × 1]&gt;
14        14 &lt;tibble [1 × 1]&gt;
15        15 &lt;tibble [1 × 1]&gt;
16        16 &lt;tibble [1 × 1]&gt;
17        17 &lt;tibble [1 × 1]&gt;
18        18 &lt;tibble [1 × 1]&gt;
19        19 &lt;tibble [1 × 1]&gt;
20        20 &lt;tibble [1 × 1]&gt;</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Lastly, we can see that the results column contains a tibble per row. We simply need to extract the values from this tibble, which we can do using the <code>unnest()</code> function. The whole workflow together, then, looks like:</li>
</ol>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>simulation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 2
   iteration         p
       &lt;int&gt;     &lt;dbl&gt;
 1         1 0.00382  
 2         2 0.343    
 3         3 0.0116   
 4         4 0.000364 
 5         5 0.112    
 6         6 0.00290  
 7         7 0.0374   
 8         8 0.000691 
 9         9 0.0618   
10        10 0.242    
11        11 0.0356   
12        12 0.00290  
13        13 0.0806   
14        14 0.00227  
15        15 0.0305   
16        16 0.000136 
17        17 0.0000243
18        18 0.0316   
19        19 0.00594  
20        20 0.00194  </code></pre>
</div>
</div>
<p>This “make a tibble, map into a list-column, then unnest()” pattern is one of the most fundamental and important ways to do tidy simulation.</p>
</section>
</section>
<section id="another-map_-variant" class="level2" data-number="6.9">
<h2 data-number="6.9" class="anchored" data-anchor-id="another-map_-variant"><span class="header-section-number">6.9</span> <strong>Another map_*() variant</strong></h2>
<p>There are several different variants of the <code>map()</code> function. You already saw one above: the <code>map_dfr()</code> function, which gave a dataframe as output instead of the list output that <code>map()</code> gives. The other <code>map_*()</code> variants follow a similar pattern - they change the type of output that comes from the <code>map_*()</code> function.</p>
<p>For example, imagine you want one number per iteration, rather than a dataframe or list. You might want a numeric vector of <em>p</em>-values. In this case, we could use <code>map_dbl()</code>.</p>
<section id="map_dbl-returns-a-numeric-vector" class="level3" data-number="6.9.1">
<h3 data-number="6.9.1" class="anchored" data-anchor-id="map_dbl-returns-a-numeric-vector"><span class="header-section-number">6.9.1</span> <strong><code>map_dbl()</code> returns a numeric vector</strong></h3>
<p>To use map_dbl(), your function must return <strong>one numeric value</strong>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(p)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>p_values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.042429758 0.061759495 0.001620464 0.001559515 0.001593142 0.060282946
 [7] 0.011576717 0.168364489 0.003829761 0.010347591</code></pre>
</div>
</div>
<p>Now p_values is a plain numeric vector. With this vector, we can do a quick summary, like look at the proportion of p-values less than 0.05:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(p_values <span class="sc">&lt;</span> .<span class="dv">05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7</code></pre>
</div>
</div>
<p>That number is an estimate of our statistical power under these parameter settings (with potentially lots of error because we only used 10 iterations). Try increasing to iterations &lt;- 1:1000 and rerun.</p>
</section>
</section>
<section id="null-vs-alternative-using-mapping" class="level2" data-number="6.10">
<h2 data-number="6.10" class="anchored" data-anchor-id="null-vs-alternative-using-mapping"><span class="header-section-number">6.10</span> <strong>Null vs alternative using mapping</strong></h2>
<p>Let’s recreate the “distribution of <em>p</em>-values under null vs alternative” simulations, but now using what we’ve learned from the <code>map()</code> functions.</p>
<p>Let’s say we want to simulate two conditions:</p>
<ul>
<li><p>mean_intervention = 0 (null - there is no true effect)</p></li>
<li><p>mean_intervention = 0.5 (alternative - there is a true effect)</p></li>
</ul>
<p>with one of two sample sizes:</p>
<ul>
<li><p>n_per_condition = 20</p></li>
<li><p>n_per_condition = 50</p></li>
</ul>
<p>and do 2000 iterations for each combination.</p>
<p>This means we have four combinations in total. We could handle this using <code>map()</code>, defining each of those conditions separately, for example like:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>simulation_results_null_twenty_per_group <span class="ot">&lt;-</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">20</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="dv">0</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>simulation_results_null_fifty_per_group <span class="ot">&lt;-</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="dv">0</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>simulation_results_alternative_twenty_per_group <span class="ot">&lt;-</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">20</span>,</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>simulation_results_alternative_fifty_per_group <span class="ot">&lt;-</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_null_twenty_per_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  iteration      p
      &lt;int&gt;  &lt;dbl&gt;
1         1 0.0760
2         2 0.988 
3         3 0.600 
4         4 0.464 
5         5 0.0305
6         6 0.252 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_null_fifty_per_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  iteration      p
      &lt;int&gt;  &lt;dbl&gt;
1         1 0.957 
2         2 0.650 
3         3 0.855 
4         4 0.0163
5         5 0.864 
6         6 0.927 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_alternative_twenty_per_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  iteration       p
      &lt;int&gt;   &lt;dbl&gt;
1         1 0.0176 
2         2 0.00102
3         3 0.734  
4         4 0.913  
5         5 0.0577 
6         6 0.631  </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_alternative_fifty_per_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  iteration        p
      &lt;int&gt;    &lt;dbl&gt;
1         1 0.000796
2         2 0.0712  
3         3 0.197   
4         4 0.00502 
5         5 0.0356  
6         6 0.000606</code></pre>
</div>
</div>
<p>As you can see, this involves some impractical copy-pasting, which (as we discussed previously) we want to avoid.</p>
<p>Our issue is that we have two different parameters (n_per_condition, mean_intervention) that we want to change. To achieve this, we cannot use <code>map()</code>, because <code>map()</code> can only handle one parameter changing at a time. Instead, we need a <code>map()</code> function that <em>can handle two inputs at once</em>. Fortunately, <code>map2()</code> was made for exactly this purpose! There also exist similar extensions for <code>map2_*()</code> as there are for <code>map_*()</code>, for example <code>map2_dfr()</code> and <code>map2_dbl()</code>: these behave identically to their <code>map_*()</code> equivalents, but just take two inputs instead of one.</p>
<section id="use-map2-to-map-multple-parameters-at-once" class="level3" data-number="6.10.1">
<h3 data-number="6.10.1" class="anchored" data-anchor-id="use-map2-to-map-multple-parameters-at-once"><span class="header-section-number">6.10.1</span> <strong>Use <code>map2()</code> to map multple parameters at once</strong></h3>
<p>Let’s first define our experiment parameters in a dataframe:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># Ian: we can omit the set seed if they haven't learned it at this point</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, <span class="dv">4</span>), <span class="co"># repeat each value of simulation 4 times</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>), <span class="at">each =</span> <span class="dv">2000</span>), <span class="dv">2</span>), <span class="co"># repeat each condition 2000 times, and do this twice</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>, .<span class="dv">5</span>, <span class="dv">0</span>), <span class="at">each =</span> <span class="dv">2000</span>)), <span class="co"># repeat each condition value 2000 times, but specify them in different combinations with n_per_condition</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="dv">0</span>, <span class="co"># mean control always = 0</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span> <span class="co"># sd always = 1</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(experiment_parameters, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   iteration n_per_condition mean_intervention mean_control    sd
       &lt;int&gt;           &lt;dbl&gt;             &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;
 1         1              20                 0            0     1
 2         2              20                 0            0     1
 3         3              20                 0            0     1
 4         4              20                 0            0     1
 5         5              20                 0            0     1
 6         6              20                 0            0     1
 7         7              20                 0            0     1
 8         8              20                 0            0     1
 9         9              20                 0            0     1
10        10              20                 0            0     1</code></pre>
</div>
</div>
<p>As you can see, we now have our range of experiments defined: 2000 iterations for each combination.</p>
<p>We’ll now run all of this over <code>map2()</code> and store:</p>
<ul>
<li><p>the generated dataset in a list-column (generated_data)</p></li>
<li><p>the analysis result in a list-column (results)</p></li>
<li><p>then unnest results</p></li>
</ul>
<p>To do this, we need to specify one input in <code>map2()</code> with the .x argument (just like <code>map()</code>), and another input with the .y argument. We specify the function (<code>generate_data()</code>, in this case) with .f.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">map2</span>(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> n_per_condition,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">.y =</span> mean_intervention,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">generate_data</span>(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_per_condition   =</span> .x,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_control      =</span> <span class="dv">0</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_intervention =</span> .y,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd                =</span> <span class="dv">1</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">map</span>(generated_data, analyze)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>simulation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8,000 × 7
   iteration n_per_condition mean_intervention mean_control    sd generated_data
       &lt;int&gt;           &lt;dbl&gt;             &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;        
 1         1              20                 0            0     1 &lt;tibble&gt;      
 2         2              20                 0            0     1 &lt;tibble&gt;      
 3         3              20                 0            0     1 &lt;tibble&gt;      
 4         4              20                 0            0     1 &lt;tibble&gt;      
 5         5              20                 0            0     1 &lt;tibble&gt;      
 6         6              20                 0            0     1 &lt;tibble&gt;      
 7         7              20                 0            0     1 &lt;tibble&gt;      
 8         8              20                 0            0     1 &lt;tibble&gt;      
 9         9              20                 0            0     1 &lt;tibble&gt;      
10        10              20                 0            0     1 &lt;tibble&gt;      
# ℹ 7,990 more rows
# ℹ 1 more variable: p &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="plot-distribution-of-p-values-for-both-conditions" class="level3" data-number="6.10.2">
<h3 data-number="6.10.2" class="anchored" data-anchor-id="plot-distribution-of-p-values-for-both-conditions"><span class="header-section-number">6.10.2</span> Plot distribution of p-values for both conditions</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> p) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mean_intervention)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="6_mapping_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The left panel shows the distribution of p-values from our simulations when mean_intervention = 0; the right panel shows the distribution of p-values from our simulations when mean_intervention = 0.5.</p>
</section>
</section>
<section id="creating-parameter-grids-more-effectively-expand_grid" class="level2" data-number="6.11">
<h2 data-number="6.11" class="anchored" data-anchor-id="creating-parameter-grids-more-effectively-expand_grid"><span class="header-section-number">6.11</span> <strong>Creating parameter grids more effectively:</strong> <code>expand_grid()</code></h2>
<p>In the example above, you will recall we constructed our parameter grid like this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, <span class="dv">4</span>), <span class="co"># repeat each value of simulation 4 times</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>), <span class="at">each =</span> <span class="dv">2000</span>), <span class="dv">2</span>), <span class="co"># repeat each condition 2000 times, and do this twice</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>, .<span class="dv">5</span>, <span class="dv">0</span>), <span class="at">each =</span> <span class="dv">2000</span>)), <span class="co"># repeat each condition value 2000 times, but specify them in different combinations with n_per_condition</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="dv">0</span>, <span class="co"># mean control always = 0</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span> <span class="co"># sd always = 1</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>However, this is actually not an ideal approach. First: you can see we are using nested <code>rep()</code> functions, which can be confusing. Second, if we ever want to move to more complex simulations (e.g., with many different parameter combinations) then it would become quite difficult to ensure that all combinations are accurately covered.</p>
<p>Instead, we can use the handy function <code>expand_grid()</code>. With this function, we give each desired value of each parameter once, and then <code>expand_grid()</code> maps this into a tibble with all combinations of all parameters.</p>
<p>For our example above, this looks like:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>expand_grid()</code> greatly simplifies the process of specifying parameters for our simulations.</p>
</section>
<section id="mapping-with-multiple-inputs-pmap" class="level2" data-number="6.12">
<h2 data-number="6.12" class="anchored" data-anchor-id="mapping-with-multiple-inputs-pmap"><span class="header-section-number">6.12</span> <strong>Mapping with multiple inputs: <code>pmap()</code></strong></h2>
<p>Above, we used <code>map2()</code> to map two inputs into a simulation. But there will be many cases where we want to map many different inputs at once - not just one or two.</p>
<p>For example: maybe we want to vary all values of n_per_condition, mean_control, mean_intervention, and sd. We could use the combination of <code>expand_grid()</code> and <code>pmap()</code> to achieve this.</p>
<p>With <code>pmap()</code>, we supply all of the parameters as a list to the .l argument, and our function (<code>generate_data()</code>) to the .f argument. We’ll use the same approach as we used previously: run <code>pmap()</code> within a <code>mutate()</code> call, then <code>map()</code> the result onto <code>analyze()</code>, then call <code>unnest()</code> on the results.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the parameters</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="co"># we'll use 100 iterations to make sure this doesn't take too long</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="fu">c</span>(.<span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># use pmap() across this</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">pmap</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">.l =</span> <span class="fu">list</span>(n_per_condition, mean_control, mean_intervention, sd),</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> generate_data),</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">map</span>(generated_data, analyze)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>simulation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,600 × 7
   iteration n_per_condition mean_intervention mean_control    sd generated_data
       &lt;int&gt;           &lt;dbl&gt;             &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;        
 1         1              20               0            0     0.5 &lt;tibble&gt;      
 2         1              20               0            0     1   &lt;tibble&gt;      
 3         1              20               0            0.1   0.5 &lt;tibble&gt;      
 4         1              20               0            0.1   1   &lt;tibble&gt;      
 5         1              20               0.5          0     0.5 &lt;tibble&gt;      
 6         1              20               0.5          0     1   &lt;tibble&gt;      
 7         1              20               0.5          0.1   0.5 &lt;tibble&gt;      
 8         1              20               0.5          0.1   1   &lt;tibble&gt;      
 9         1              50               0            0     0.5 &lt;tibble&gt;      
10         1              50               0            0     1   &lt;tibble&gt;      
# ℹ 1,590 more rows
# ℹ 1 more variable: p &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="pmap-for-parameter-sweeps" class="level2" data-number="6.13">
<h2 data-number="6.13" class="anchored" data-anchor-id="pmap-for-parameter-sweeps"><span class="header-section-number">6.13</span> <strong><code>pmap()</code> for parameter sweeps</strong></h2>
<p>This is the most common simulation pattern in this course:</p>
<ol type="1">
<li><p>Make a parameter grid (<code>expand_grid()</code>)</p></li>
<li><p>Use <code>pmap()</code> to run the simulation for each row</p></li>
<li><p>Summarize results grouped by the manipulated parameters</p></li>
</ol>
<p>Here’s another example: statistical power as a function of sample size and effect size.</p>
<section id="specify-the-parameter-grid" class="level3" data-number="6.13.1">
<h3 data-number="6.13.1" class="anchored" data-anchor-id="specify-the-parameter-grid"><span class="header-section-number">6.13.1</span> Specify the parameter grid</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>experiment_parameters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,000 × 5
   n_per_condition mean_intervention iteration mean_control    sd
             &lt;dbl&gt;             &lt;dbl&gt;     &lt;int&gt;        &lt;dbl&gt; &lt;dbl&gt;
 1              20                 0         1            0     1
 2              20                 0         2            0     1
 3              20                 0         3            0     1
 4              20                 0         4            0     1
 5              20                 0         5            0     1
 6              20                 0         6            0     1
 7              20                 0         7            0     1
 8              20                 0         8            0     1
 9              20                 0         9            0     1
10              20                 0        10            0     1
# ℹ 8,990 more rows</code></pre>
</div>
</div>
</section>
<section id="run-the-simulations" class="level3" data-number="6.13.2">
<h3 data-number="6.13.2" class="anchored" data-anchor-id="run-the-simulations"><span class="header-section-number">6.13.2</span> Run the simulations</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">pmap</span>(</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">.l =</span> <span class="fu">list</span>(n_per_condition, mean_control, mean_intervention, sd), </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> generate_data),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">map</span>(generated_data, analyze)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>simulation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,000 × 7
   n_per_condition mean_intervention iteration mean_control    sd generated_data
             &lt;dbl&gt;             &lt;dbl&gt;     &lt;int&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;        
 1              20                 0         1            0     1 &lt;tibble&gt;      
 2              20                 0         2            0     1 &lt;tibble&gt;      
 3              20                 0         3            0     1 &lt;tibble&gt;      
 4              20                 0         4            0     1 &lt;tibble&gt;      
 5              20                 0         5            0     1 &lt;tibble&gt;      
 6              20                 0         6            0     1 &lt;tibble&gt;      
 7              20                 0         7            0     1 &lt;tibble&gt;      
 8              20                 0         8            0     1 &lt;tibble&gt;      
 9              20                 0         9            0     1 &lt;tibble&gt;      
10              20                 0        10            0     1 &lt;tibble&gt;      
# ℹ 8,990 more rows
# ℹ 1 more variable: p &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="get-results-per-parameter-combination" class="level3" data-number="6.13.3">
<h3 data-number="6.13.3" class="anchored" data-anchor-id="get-results-per-parameter-combination"><span class="header-section-number">6.13.3</span> Get results per parameter combination</h3>
<p>Finally, we can <code>group_by()</code> the different parameters we manipulated (n_per_condition, mean_intervention) and <code>summarise()</code> the proportion of significant p-values in each case:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>power_summary <span class="ot">&lt;-</span> simulation_results <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">significant =</span> p <span class="sc">&lt;</span> .<span class="dv">05</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n_per_condition, mean_intervention) <span class="sc">|&gt;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">power =</span> <span class="fu">mean</span>(significant), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>power_summary </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  n_per_condition mean_intervention power
            &lt;dbl&gt;             &lt;dbl&gt; &lt;dbl&gt;
1              20               0   0.044
2              20               0.2 0.077
3              20               0.5 0.356
4              50               0   0.042
5              50               0.2 0.182
6              50               0.5 0.671
7             100               0   0.051
8             100               0.2 0.302
9             100               0.5 0.927</code></pre>
</div>
</div>
</section>
</section>
<section id="nested-data-frames-list-columns-are-useful" class="level2" data-number="6.14">
<h2 data-number="6.14" class="anchored" data-anchor-id="nested-data-frames-list-columns-are-useful"><span class="header-section-number">6.14</span> <strong>Nested data frames (list-columns) are useful</strong></h2>
<p>When you map a function that returns a data frame, you get a list-column where each cell contains a data frame.</p>
<p>This is extremely useful because it keeps your workflow tidy:</p>
<ul>
<li><p>One row = one simulation condition (or one iteration)</p></li>
<li><p>One list-column = the simulated dataset or the model object</p></li>
<li><p>Another list-column = the results</p></li>
</ul>
<p>You already saw this with generated_data and results. The only new skill is:</p>
<ul>
<li><p>knowing that list-columns exist</p></li>
<li><p>being comfortable with unnest() when you want to “flatten” results</p></li>
</ul>
</section>
<section id="parallel-mapping-with-furrr" class="level2" data-number="6.15">
<h2 data-number="6.15" class="anchored" data-anchor-id="parallel-mapping-with-furrr"><span class="header-section-number">6.15</span> <strong>Parallel mapping with {furrr}</strong></h2>
<p>With the <code>map()</code> family of functions we have discussed in this chapter, simulations are run <em>in sequence</em>. For example, if we are running 100 iterations, this means that iteration 1 is run first; then iteration 2 is run; then iteration 3; etc.</p>
<p>When you’re doing hundreds of thousands, millions, (or billions!) of iterations, running simulations in sequence can take a long time. In such cases, we ideally would run many of the simulations <em>in parallel</em> to speed things up (e.g., running the first 5 iterations at once; then the next 5; etc.). This is called parallelisation, and it can dramatically speed up simulations.</p>
<p>The package for running parallelised simulations is called {furrr}. {furrr} has versions of the <code>map()</code> functions that mirror those in {purrr}:</p>
<ul>
<li><p><code>future_map()</code> is the parallelised version of <code>map()</code></p></li>
<li><p><code>future_map_dfr()</code> is the parallelised version of <code>map_dfr()</code></p></li>
<li><p><code>future_pmap()</code> is the parallelised version of <code>pmap()</code></p></li>
</ul>
<p>Here is the same “simulate grid” idea, but using future_pmap().</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>simulation_parallel <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">future_pmap</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">.l =</span> <span class="fu">list</span>(n_per_condition, mean_control, mean_intervention, sd),</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> generate_data,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">future_map</span>(</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>      generated_data,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>      analyze,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>simulation_parallel <span class="sc">|&gt;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results) <span class="sc">|&gt;</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mean_intervention) <span class="sc">|&gt;</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">significant =</span> p <span class="sc">&lt;</span> .<span class="dv">05</span>) <span class="sc">|&gt;</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">proportion_significant =</span> <span class="fu">mean</span>(significant)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  mean_intervention proportion_significant
              &lt;dbl&gt;                  &lt;dbl&gt;
1               0                   0.0557
2               0.2                 0.188 
3               0.5                 0.658 </code></pre>
</div>
</div>
</section>
<section id="summary" class="level2" data-number="6.16">
<h2 data-number="6.16" class="anchored" data-anchor-id="summary"><span class="header-section-number">6.16</span> <strong>Summary</strong></h2>
<p>You now have the core “engine” for simulation in tidyverse form:</p>
<ul>
<li><p><code>expand_grid()</code> creates the experiment</p></li>
<li><p><code>map()</code> / <code>map2()</code> / <code>pmap()</code> repeats the simulation</p></li>
<li><p>list-columns store complex outputs cleanly</p></li>
<li><p><code>unnest()</code> flattens results for summarizing and plotting</p></li>
<li><p><code>map_dbl()</code> and <code>map_dfr()</code> help you get outputs in the shape you want</p></li>
<li><p><code>future_*()</code> variants can make big simulations faster</p></li>
</ul>
</section>
<section id="exercises" class="level2" data-number="6.17">
<h2 data-number="6.17" class="anchored" data-anchor-id="exercises"><span class="header-section-number">6.17</span> <strong>Exercises</strong></h2>
<section id="warm-up-map-a-simple-function" class="level3" data-number="6.17.1">
<h3 data-number="6.17.1" class="anchored" data-anchor-id="warm-up-map-a-simple-function"><span class="header-section-number">6.17.1</span> <strong>Warm-up: map a simple function</strong></h3>
<ol type="1">
<li><p>Create iterations &lt;- 1:20.</p></li>
<li><p>Use map() to compute sqrt() of each iteration.</p></li>
<li><p>What type of object does map() return?</p></li>
</ol>
</section>
<section id="map-a-simulation-200-times" class="level3" data-number="6.17.2">
<h3 data-number="6.17.2" class="anchored" data-anchor-id="map-a-simulation-200-times"><span class="header-section-number">6.17.2</span> <strong>Map a simulation 200 times</strong></h3>
<ol type="1">
<li><p>Set iterations &lt;- 1:200.</p></li>
<li><p>Use map_dfr() to run generate_data(…) |&gt; analyze() 200 times.</p></li>
<li><p>Compute the proportion of p &lt; .05.</p></li>
</ol>
</section>
<section id="extract-a-numeric-vector-of-p-values" class="level3" data-number="6.17.3">
<h3 data-number="6.17.3" class="anchored" data-anchor-id="extract-a-numeric-vector-of-p-values"><span class="header-section-number">6.17.3</span> <strong>Extract a numeric vector of p-values</strong></h3>
<ol type="1">
<li><p>Repeat the last exercise, but use map_dbl() to return a numeric vector.</p></li>
<li><p>Plot a histogram of the p-values.</p></li>
</ol>
</section>
<section id="make-a-tiny-experiment-with-expand_grid-pmap" class="level3" data-number="6.17.4">
<h3 data-number="6.17.4" class="anchored" data-anchor-id="make-a-tiny-experiment-with-expand_grid-pmap"><span class="header-section-number">6.17.4</span> <strong>Make a tiny experiment with expand_grid() + pmap()</strong></h3>
<ol type="1">
<li><p>Use expand_grid() to create an experiment with:</p>
<ul>
<li><p>mean_intervention = c(0.3, 0.7)</p></li>
<li><p>iteration = 1:1000</p></li>
<li><p>n_per_condition = c(25, 100)</p></li>
<li><p>mean_control = 0</p></li>
<li><p>sd = c(0.5, 1)</p></li>
</ul></li>
<li><p>Use <code>pmap()</code> + <code>map()</code> to generate and analyze.</p></li>
<li><p>Plot the distribution of p-values and estimate power for each condition (one number per effect size).</p></li>
</ol>
</section>
<section id="optional-parallelize" class="level3" data-number="6.17.5">
<h3 data-number="6.17.5" class="anchored" data-anchor-id="optional-parallelize"><span class="header-section-number">6.17.5</span> <strong>(Optional) Parallelize</strong></h3>
<ol type="1">
<li><p>Replace your <code>pmap()</code> call with <code>future_pmap()</code>.</p></li>
<li><p>Does it run faster?</p></li>
</ol>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/5_creating_simulation_experiments.html" class="pagination-link" aria-label="Creating simulation experiments">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Creating simulation experiments</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/7_summarizing_results.html" class="pagination-link" aria-label="Summarizing results">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Summarizing results</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb58" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Mapping over functions</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview of tutorial</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>In the last lesson, you wrote a data-generation function (<span class="in">`generate_data()`</span>) and an analysis function (<span class="in">`analyze()`</span>), then called them once with the pipe:</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>generate one dataset\</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>analyze it\</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>get a result (e.g., one *p*-value)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>A simulation study is just doing that many times, and then summarizing the results.</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>The big question for this lesson:</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>How do we repeat the same “generate → analyze” workflow lots of times, without copy–pasting code?</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>Answer: **mapping**. In the tidyverse, this is usually done with the <span class="in">`{purrr}`</span> package (and, later, <span class="in">`{furrr}`</span> for parallel processing).</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you should be able to:</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`map()`</span> to repeat a simulation many times.</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`map_dbl()`</span> / <span class="in">`map_int()`</span> / <span class="in">`map_chr()`</span> to get clean vectors out.</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`map_dfr()`</span> to bind outputs into a tibble.</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`map2()`</span> and <span class="in">`pmap()`</span> to run parameter sweeps.</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Understand what it means when mapping produces nested data frames (list-columns).</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`future_map()`</span> / <span class="in">`future_pmap()`</span> (from <span class="in">`{furrr}`</span>) when you want to parallelize.</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dependencies</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a><span class="co"># set up parallelization (we will use this later in the chapter)</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Recap: generate and analyze functions**</span></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>Here is the same example setup you saw earlier: two conditions (control vs intervention), normally distributed scores, and a two-sample *t*-test.</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(n_per_condition,</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>                          mean_control,</span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>                          mean_intervention,</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>                          sd) {</span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>  data_control <span class="ot">&lt;-</span></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">condition =</span> <span class="st">"control"</span>,</span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>           <span class="at">score =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_per_condition, <span class="at">mean =</span> mean_control, <span class="at">sd =</span> sd))</span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>  data_intervention <span class="ot">&lt;-</span></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">condition =</span> <span class="st">"intervention"</span>,</span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>           <span class="at">score =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_per_condition, <span class="at">mean =</span> mean_intervention, <span class="at">sd =</span> sd))</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a>  data_combined <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data_control, data_intervention)</span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_combined)</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>analyze <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a>  res_t_test <span class="ot">&lt;-</span> <span class="fu">t.test</span>(<span class="at">formula =</span> score <span class="sc">~</span> condition,</span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> data,</span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var.equal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alternative =</span> <span class="st">"two.sided"</span>)</span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> res_t_test<span class="sc">$</span>p.value)</span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Doing it once**</span></span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span></span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a>                <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a>                <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a>                <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze</span>()</span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true" tabindex="-1"></a>results</span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Why copy–paste is the enemy**</span></span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true" tabindex="-1"></a>You already saw the “bad” way: calling the same code block over and over and binding it with bind_rows().</span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true" tabindex="-1"></a>This is bad because:</span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>It’s slow to write and easy to make mistakes.</span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>It’s hard to scale from 25 iterations to 10,000 iterations.</span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>It’s hard to turn into a proper experiment (varying parameters systematically).</span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true" tabindex="-1"></a>So: we need a principled way to repeat the same computation. To do this, we can use the "<span class="in">`map()`</span>" family of functions in R.</span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-116"><a href="#cb58-116" aria-hidden="true" tabindex="-1"></a><span class="fu">## **The core idea of mapping**</span></span>
<span id="cb58-117"><a href="#cb58-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-118"><a href="#cb58-118" aria-hidden="true" tabindex="-1"></a><span class="fu">### **map() repeats a function over a vector/list**</span></span>
<span id="cb58-119"><a href="#cb58-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-120"><a href="#cb58-120" aria-hidden="true" tabindex="-1"></a>purrr::map() takes:</span>
<span id="cb58-121"><a href="#cb58-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-122"><a href="#cb58-122" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>a vector/list of inputs (.x)</span>
<span id="cb58-123"><a href="#cb58-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-124"><a href="#cb58-124" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>a function (.f)</span>
<span id="cb58-125"><a href="#cb58-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-126"><a href="#cb58-126" aria-hidden="true" tabindex="-1"></a>    and returns a **list of outputs** (always a list).</span>
<span id="cb58-127"><a href="#cb58-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-128"><a href="#cb58-128" aria-hidden="true" tabindex="-1"></a>Let's look at a simple example. Imagine we have a vector of numbers (from 1 to 4) and, for each number, we want to add 10. We can use <span class="in">`map()`</span> to do this:</span>
<span id="cb58-129"><a href="#cb58-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-132"><a href="#cb58-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-133"><a href="#cb58-133" aria-hidden="true" tabindex="-1"></a>numbers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb58-134"><a href="#cb58-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-135"><a href="#cb58-135" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(numbers, <span class="sc">~</span> .x <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb58-136"><a href="#cb58-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-137"><a href="#cb58-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-138"><a href="#cb58-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-139"><a href="#cb58-139" aria-hidden="true" tabindex="-1"></a>Notice the output is a list, even though each element is just a number. This is on purpose: returning a list is the “safest” default, because in real work you might return complicated objects (models, data frames, plots…) and lists handle these diverse objects most effectively, and prevent errors from arising.</span>
<span id="cb58-140"><a href="#cb58-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-141"><a href="#cb58-141" aria-hidden="true" tabindex="-1"></a><span class="fu">### **The anonymous-function shorthand: `~`**</span></span>
<span id="cb58-142"><a href="#cb58-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-143"><a href="#cb58-143" aria-hidden="true" tabindex="-1"></a>When you look at the example above, you might be wondering: what is the **`~`** symbol, and what is it doing? This is referred to as the **anonymous-function (lambda) shorthand** in {purrr} formula syntax. This lets you define a short function within the <span class="in">`map()`</span> family of functions. In the case above, our function was "add 10 to the input", where .x stands for the current input.</span>
<span id="cb58-144"><a href="#cb58-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-145"><a href="#cb58-145" aria-hidden="true" tabindex="-1"></a>More concretely, the two lines of code below are equivalent:</span>
<span id="cb58-146"><a href="#cb58-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-147"><a href="#cb58-147" aria-hidden="true" tabindex="-1"></a>Line 1:</span>
<span id="cb58-148"><a href="#cb58-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-151"><a href="#cb58-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-152"><a href="#cb58-152" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(numbers, <span class="cf">function</span>(x) x <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb58-153"><a href="#cb58-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-154"><a href="#cb58-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-155"><a href="#cb58-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-156"><a href="#cb58-156" aria-hidden="true" tabindex="-1"></a>Line 2:</span>
<span id="cb58-157"><a href="#cb58-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-160"><a href="#cb58-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-161"><a href="#cb58-161" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(numbers, <span class="sc">~</span> .x <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb58-162"><a href="#cb58-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-163"><a href="#cb58-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-164"><a href="#cb58-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-165"><a href="#cb58-165" aria-hidden="true" tabindex="-1"></a>You’ll see the \~ .x style constantly in tidyverse simulation code.</span>
<span id="cb58-166"><a href="#cb58-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-167"><a href="#cb58-167" aria-hidden="true" tabindex="-1"></a><span class="fu">## **A first simulation with map()**</span></span>
<span id="cb58-168"><a href="#cb58-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-169"><a href="#cb58-169" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Map over iterations**</span></span>
<span id="cb58-170"><a href="#cb58-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-171"><a href="#cb58-171" aria-hidden="true" tabindex="-1"></a>Ideally, simulations need an iteration index, which tells us what "round" of the simulation a given set of outputs are part of. We can often define these iterations simply, like:</span>
<span id="cb58-172"><a href="#cb58-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-175"><a href="#cb58-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-176"><a href="#cb58-176" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb58-177"><a href="#cb58-177" aria-hidden="true" tabindex="-1"></a>iterations</span>
<span id="cb58-178"><a href="#cb58-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-179"><a href="#cb58-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-180"><a href="#cb58-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-181"><a href="#cb58-181" aria-hidden="true" tabindex="-1"></a>Now we map over iterations. For now, the iteration number doesn’t do anything - we just need to supply <span class="in">`map()`</span> with a set of values to run across.</span>
<span id="cb58-182"><a href="#cb58-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-185"><a href="#cb58-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-186"><a href="#cb58-186" aria-hidden="true" tabindex="-1"></a>simulation_results_list <span class="ot">&lt;-</span></span>
<span id="cb58-187"><a href="#cb58-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb58-188"><a href="#cb58-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-189"><a href="#cb58-189" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-190"><a href="#cb58-190" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-191"><a href="#cb58-191" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-192"><a href="#cb58-192" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-193"><a href="#cb58-193" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb58-194"><a href="#cb58-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-195"><a href="#cb58-195" aria-hidden="true" tabindex="-1"></a>simulation_results_list</span>
<span id="cb58-196"><a href="#cb58-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-197"><a href="#cb58-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-198"><a href="#cb58-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-199"><a href="#cb58-199" aria-hidden="true" tabindex="-1"></a>You should see a list of tibbles, each tibble containing one *p*-value.</span>
<span id="cb58-200"><a href="#cb58-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-201"><a href="#cb58-201" aria-hidden="true" tabindex="-1"></a>If we change the number of iterations, then the number of times <span class="in">`map()`</span> is called will change:</span>
<span id="cb58-202"><a href="#cb58-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-205"><a href="#cb58-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-206"><a href="#cb58-206" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span></span>
<span id="cb58-207"><a href="#cb58-207" aria-hidden="true" tabindex="-1"></a>iterations</span>
<span id="cb58-208"><a href="#cb58-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-209"><a href="#cb58-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-210"><a href="#cb58-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-213"><a href="#cb58-213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-214"><a href="#cb58-214" aria-hidden="true" tabindex="-1"></a>simulation_results_list <span class="ot">&lt;-</span></span>
<span id="cb58-215"><a href="#cb58-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb58-216"><a href="#cb58-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-217"><a href="#cb58-217" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-218"><a href="#cb58-218" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-219"><a href="#cb58-219" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-220"><a href="#cb58-220" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-221"><a href="#cb58-221" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb58-222"><a href="#cb58-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-223"><a href="#cb58-223" aria-hidden="true" tabindex="-1"></a>simulation_results_list</span>
<span id="cb58-224"><a href="#cb58-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-225"><a href="#cb58-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-226"><a href="#cb58-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-227"><a href="#cb58-227" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Extract one element**</span></span>
<span id="cb58-228"><a href="#cb58-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-229"><a href="#cb58-229" aria-hidden="true" tabindex="-1"></a>Elements from the list output of <span class="in">`map()`</span> are accessed with <span class="sc">\[\[</span> <span class="sc">\]\]</span>. For example, if we want the output of the first iteration, we can do this:</span>
<span id="cb58-230"><a href="#cb58-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-233"><a href="#cb58-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-234"><a href="#cb58-234" aria-hidden="true" tabindex="-1"></a>simulation_results_list[[<span class="dv">1</span>]]</span>
<span id="cb58-235"><a href="#cb58-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-236"><a href="#cb58-236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-237"><a href="#cb58-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-238"><a href="#cb58-238" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Turning a list into a tidy tibble**</span></span>
<span id="cb58-239"><a href="#cb58-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-240"><a href="#cb58-240" aria-hidden="true" tabindex="-1"></a>Even though lists are helpful for preventing errors, we ideally would prefer the output to be in a tidy format, like a dataframe or a tibble, since this is easier to work with later. To get this type of tidier output, we can use the <span class="in">`map_dfr()`</span> function, which returns dataframes as output instead of lists.</span>
<span id="cb58-241"><a href="#cb58-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-242"><a href="#cb58-242" aria-hidden="true" tabindex="-1"></a>If each iteration returns a tibble with the same columns (in our case, a single column called p), map_dfr() will map and then bind the outputs together into a single dataframe.</span>
<span id="cb58-243"><a href="#cb58-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-246"><a href="#cb58-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-247"><a href="#cb58-247" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span></span>
<span id="cb58-248"><a href="#cb58-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb58-249"><a href="#cb58-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-250"><a href="#cb58-250" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-251"><a href="#cb58-251" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-252"><a href="#cb58-252" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-253"><a href="#cb58-253" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-254"><a href="#cb58-254" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb58-255"><a href="#cb58-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-256"><a href="#cb58-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-257"><a href="#cb58-257" aria-hidden="true" tabindex="-1"></a>simulation_results</span>
<span id="cb58-258"><a href="#cb58-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-259"><a href="#cb58-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-260"><a href="#cb58-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-261"><a href="#cb58-261" aria-hidden="true" tabindex="-1"></a>As you can see, now simulation_results is a single tibble, not a list.</span>
<span id="cb58-262"><a href="#cb58-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-263"><a href="#cb58-263" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Add the iteration number**</span></span>
<span id="cb58-264"><a href="#cb58-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-265"><a href="#cb58-265" aria-hidden="true" tabindex="-1"></a>When we look at the nice output above from <span class="in">`map_dfr`</span>, we're missing one important piece of information: the iteration number! As we said above, we ideally want to keep this number so we know what result belongs to what step of the simulation.</span>
<span id="cb58-266"><a href="#cb58-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-267"><a href="#cb58-267" aria-hidden="true" tabindex="-1"></a>We can do this by going back to the original <span class="in">`map()`</span> function with some small additions. Specifically:</span>
<span id="cb58-268"><a href="#cb58-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-269"><a href="#cb58-269" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>We create a tibble with a single column, called iteration (or whatever we want), and assign this a vector of values from 1 to the number of iterations we want. For example, if we want 20 iterations:</span>
<span id="cb58-270"><a href="#cb58-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-273"><a href="#cb58-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-274"><a href="#cb58-274" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb58-275"><a href="#cb58-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-276"><a href="#cb58-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-277"><a href="#cb58-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-278"><a href="#cb58-278" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>We mutate a new column into this new tibble, called results (or whatever we want to call it). Then we run <span class="in">`map()`</span> within the <span class="in">`mutate()`</span> call using the iteration column and our <span class="in">`generate_data()`</span> and <span class="in">`analyze()`</span> functions, like this:</span>
<span id="cb58-279"><a href="#cb58-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-282"><a href="#cb58-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-283"><a href="#cb58-283" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span></span>
<span id="cb58-284"><a href="#cb58-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb58-285"><a href="#cb58-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb58-286"><a href="#cb58-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-287"><a href="#cb58-287" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-288"><a href="#cb58-288" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-289"><a href="#cb58-289" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-290"><a href="#cb58-290" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-291"><a href="#cb58-291" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb58-292"><a href="#cb58-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-293"><a href="#cb58-293" aria-hidden="true" tabindex="-1"></a>simulation_results</span>
<span id="cb58-294"><a href="#cb58-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-295"><a href="#cb58-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-296"><a href="#cb58-296" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Lastly, we can see that the results column contains a tibble per row. We simply need to extract the values from this tibble, which we can do using the <span class="in">`unnest()`</span> function. The whole workflow together, then, looks like:</span>
<span id="cb58-297"><a href="#cb58-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-300"><a href="#cb58-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-301"><a href="#cb58-301" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span></span>
<span id="cb58-302"><a href="#cb58-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb58-303"><a href="#cb58-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb58-304"><a href="#cb58-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-305"><a href="#cb58-305" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-306"><a href="#cb58-306" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-307"><a href="#cb58-307" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-308"><a href="#cb58-308" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-309"><a href="#cb58-309" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb58-310"><a href="#cb58-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-311"><a href="#cb58-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-312"><a href="#cb58-312" aria-hidden="true" tabindex="-1"></a>simulation_results</span>
<span id="cb58-313"><a href="#cb58-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-314"><a href="#cb58-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-315"><a href="#cb58-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-316"><a href="#cb58-316" aria-hidden="true" tabindex="-1"></a>This "make a tibble, map into a list-column, then unnest()" pattern is one of the most fundamental and important ways to do tidy simulation.</span>
<span id="cb58-317"><a href="#cb58-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-318"><a href="#cb58-318" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Another map\_\*() variant**</span></span>
<span id="cb58-319"><a href="#cb58-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-320"><a href="#cb58-320" aria-hidden="true" tabindex="-1"></a>There are several different variants of the <span class="in">`map()`</span> function. You already saw one above: the <span class="in">`map_dfr()`</span> function, which gave a dataframe as output instead of the list output that <span class="in">`map()`</span> gives. The other <span class="in">`map_*()`</span> variants follow a similar pattern - they change the type of output that comes from the <span class="in">`map_*()`</span> function.</span>
<span id="cb58-321"><a href="#cb58-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-322"><a href="#cb58-322" aria-hidden="true" tabindex="-1"></a>For example, imagine you want one number per iteration, rather than a dataframe or list. You might want a numeric vector of *p*-values. In this case, we could use <span class="in">`map_dbl()`</span>.</span>
<span id="cb58-323"><a href="#cb58-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-324"><a href="#cb58-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### **`map_dbl()` returns a numeric vector**</span></span>
<span id="cb58-325"><a href="#cb58-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-326"><a href="#cb58-326" aria-hidden="true" tabindex="-1"></a>To use map_dbl(), your function must return **one numeric value**.</span>
<span id="cb58-327"><a href="#cb58-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-330"><a href="#cb58-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-331"><a href="#cb58-331" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb58-332"><a href="#cb58-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-333"><a href="#cb58-333" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span></span>
<span id="cb58-334"><a href="#cb58-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(iterations, <span class="sc">~</span> {</span>
<span id="cb58-335"><a href="#cb58-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-336"><a href="#cb58-336" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-337"><a href="#cb58-337" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-338"><a href="#cb58-338" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-339"><a href="#cb58-339" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>() <span class="sc">|&gt;</span></span>
<span id="cb58-340"><a href="#cb58-340" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(p)</span>
<span id="cb58-341"><a href="#cb58-341" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb58-342"><a href="#cb58-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-343"><a href="#cb58-343" aria-hidden="true" tabindex="-1"></a>p_values</span>
<span id="cb58-344"><a href="#cb58-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-345"><a href="#cb58-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-346"><a href="#cb58-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-347"><a href="#cb58-347" aria-hidden="true" tabindex="-1"></a>Now p_values is a plain numeric vector. With this vector, we can do a quick summary, like look at the proportion of p-values less than 0.05:</span>
<span id="cb58-348"><a href="#cb58-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-351"><a href="#cb58-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-352"><a href="#cb58-352" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(p_values <span class="sc">&lt;</span> .<span class="dv">05</span>)</span>
<span id="cb58-353"><a href="#cb58-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-354"><a href="#cb58-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-355"><a href="#cb58-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-356"><a href="#cb58-356" aria-hidden="true" tabindex="-1"></a>That number is an estimate of our statistical power under these parameter settings (with potentially lots of error because we only used 10 iterations). Try increasing to iterations <span class="sc">\&lt;</span>- 1:1000 and rerun.</span>
<span id="cb58-357"><a href="#cb58-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-358"><a href="#cb58-358" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Null vs alternative using mapping**</span></span>
<span id="cb58-359"><a href="#cb58-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-360"><a href="#cb58-360" aria-hidden="true" tabindex="-1"></a>Let’s recreate the “distribution of *p*-values under null vs alternative” simulations, but now using what we've learned from the <span class="in">`map()`</span> functions.</span>
<span id="cb58-361"><a href="#cb58-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-362"><a href="#cb58-362" aria-hidden="true" tabindex="-1"></a>Let's say we want to simulate two conditions:</span>
<span id="cb58-363"><a href="#cb58-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-364"><a href="#cb58-364" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>mean_intervention = 0 (null - there is no true effect)</span>
<span id="cb58-365"><a href="#cb58-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-366"><a href="#cb58-366" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>mean_intervention = 0.5 (alternative - there is a true effect)</span>
<span id="cb58-367"><a href="#cb58-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-368"><a href="#cb58-368" aria-hidden="true" tabindex="-1"></a>with one of two sample sizes:</span>
<span id="cb58-369"><a href="#cb58-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-370"><a href="#cb58-370" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>n_per_condition = 20</span>
<span id="cb58-371"><a href="#cb58-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-372"><a href="#cb58-372" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>n_per_condition = 50</span>
<span id="cb58-373"><a href="#cb58-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-374"><a href="#cb58-374" aria-hidden="true" tabindex="-1"></a>and do 2000 iterations for each combination.</span>
<span id="cb58-375"><a href="#cb58-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-376"><a href="#cb58-376" aria-hidden="true" tabindex="-1"></a>This means we have four combinations in total. We could handle this using <span class="in">`map()`</span>, defining each of those conditions separately, for example like:</span>
<span id="cb58-377"><a href="#cb58-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-380"><a href="#cb58-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-381"><a href="#cb58-381" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span></span>
<span id="cb58-382"><a href="#cb58-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-383"><a href="#cb58-383" aria-hidden="true" tabindex="-1"></a>simulation_results_null_twenty_per_group <span class="ot">&lt;-</span></span>
<span id="cb58-384"><a href="#cb58-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb58-385"><a href="#cb58-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb58-386"><a href="#cb58-386" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">20</span>,</span>
<span id="cb58-387"><a href="#cb58-387" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-388"><a href="#cb58-388" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="dv">0</span>,</span>
<span id="cb58-389"><a href="#cb58-389" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-390"><a href="#cb58-390" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-391"><a href="#cb58-391" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb58-392"><a href="#cb58-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-393"><a href="#cb58-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-394"><a href="#cb58-394" aria-hidden="true" tabindex="-1"></a>simulation_results_null_fifty_per_group <span class="ot">&lt;-</span></span>
<span id="cb58-395"><a href="#cb58-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb58-396"><a href="#cb58-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb58-397"><a href="#cb58-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-398"><a href="#cb58-398" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-399"><a href="#cb58-399" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="dv">0</span>,</span>
<span id="cb58-400"><a href="#cb58-400" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-401"><a href="#cb58-401" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-402"><a href="#cb58-402" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb58-403"><a href="#cb58-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-404"><a href="#cb58-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-405"><a href="#cb58-405" aria-hidden="true" tabindex="-1"></a>simulation_results_alternative_twenty_per_group <span class="ot">&lt;-</span></span>
<span id="cb58-406"><a href="#cb58-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb58-407"><a href="#cb58-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb58-408"><a href="#cb58-408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">20</span>,</span>
<span id="cb58-409"><a href="#cb58-409" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-410"><a href="#cb58-410" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-411"><a href="#cb58-411" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-412"><a href="#cb58-412" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-413"><a href="#cb58-413" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb58-414"><a href="#cb58-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-415"><a href="#cb58-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-416"><a href="#cb58-416" aria-hidden="true" tabindex="-1"></a>simulation_results_alternative_fifty_per_group <span class="ot">&lt;-</span></span>
<span id="cb58-417"><a href="#cb58-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">iteration =</span> iterations) <span class="sc">|&gt;</span></span>
<span id="cb58-418"><a href="#cb58-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(iteration, <span class="sc">~</span> {</span>
<span id="cb58-419"><a href="#cb58-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_data</span>(<span class="at">n_per_condition =</span> <span class="dv">50</span>,</span>
<span id="cb58-420"><a href="#cb58-420" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-421"><a href="#cb58-421" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean_intervention =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-422"><a href="#cb58-422" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-423"><a href="#cb58-423" aria-hidden="true" tabindex="-1"></a>      <span class="fu">analyze</span>()</span>
<span id="cb58-424"><a href="#cb58-424" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">|&gt;</span></span>
<span id="cb58-425"><a href="#cb58-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-426"><a href="#cb58-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-427"><a href="#cb58-427" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_null_twenty_per_group)</span>
<span id="cb58-428"><a href="#cb58-428" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_null_fifty_per_group)</span>
<span id="cb58-429"><a href="#cb58-429" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_alternative_twenty_per_group)</span>
<span id="cb58-430"><a href="#cb58-430" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(simulation_results_alternative_fifty_per_group)</span>
<span id="cb58-431"><a href="#cb58-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-432"><a href="#cb58-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-433"><a href="#cb58-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-434"><a href="#cb58-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-435"><a href="#cb58-435" aria-hidden="true" tabindex="-1"></a>As you can see, this involves some impractical copy-pasting, which (as we discussed previously) we want to avoid.</span>
<span id="cb58-436"><a href="#cb58-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-437"><a href="#cb58-437" aria-hidden="true" tabindex="-1"></a>Our issue is that we have two different parameters (n_per_condition, mean_intervention) that we want to change. To achieve this, we cannot use <span class="in">`map()`</span>, because <span class="in">`map()`</span> can only handle one parameter changing at a time. Instead, we need a <span class="in">`map()`</span> function that *can handle two inputs at once*. Fortunately, `map2()` was made for exactly this purpose! There also exist similar extensions for `map2_*()` as there are for `map_*()`, for example `map2_dfr()` and `map2_dbl()`: these behave identically to their `map_*()` equivalents, but just take two inputs instead of one.</span>
<span id="cb58-438"><a href="#cb58-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-439"><a href="#cb58-439" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Use `map2()` to map multple parameters at once**</span></span>
<span id="cb58-440"><a href="#cb58-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-441"><a href="#cb58-441" aria-hidden="true" tabindex="-1"></a>Let's first define our experiment parameters in a dataframe:</span>
<span id="cb58-442"><a href="#cb58-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-445"><a href="#cb58-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-446"><a href="#cb58-446" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># Ian: we can omit the set seed if they haven't learned it at this point</span></span>
<span id="cb58-447"><a href="#cb58-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-448"><a href="#cb58-448" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb58-449"><a href="#cb58-449" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, <span class="dv">4</span>), <span class="co"># repeat each value of simulation 4 times</span></span>
<span id="cb58-450"><a href="#cb58-450" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>), <span class="at">each =</span> <span class="dv">2000</span>), <span class="dv">2</span>), <span class="co"># repeat each condition 2000 times, and do this twice</span></span>
<span id="cb58-451"><a href="#cb58-451" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>, .<span class="dv">5</span>, <span class="dv">0</span>), <span class="at">each =</span> <span class="dv">2000</span>)), <span class="co"># repeat each condition value 2000 times, but specify them in different combinations with n_per_condition</span></span>
<span id="cb58-452"><a href="#cb58-452" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="dv">0</span>, <span class="co"># mean control always = 0</span></span>
<span id="cb58-453"><a href="#cb58-453" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span> <span class="co"># sd always = 1</span></span>
<span id="cb58-454"><a href="#cb58-454" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-455"><a href="#cb58-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-456"><a href="#cb58-456" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(experiment_parameters, <span class="dv">10</span>)</span>
<span id="cb58-457"><a href="#cb58-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-458"><a href="#cb58-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-459"><a href="#cb58-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-460"><a href="#cb58-460" aria-hidden="true" tabindex="-1"></a>As you can see, we now have our range of experiments defined: 2000 iterations for each combination.</span>
<span id="cb58-461"><a href="#cb58-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-462"><a href="#cb58-462" aria-hidden="true" tabindex="-1"></a>We’ll now run all of this over <span class="in">`map2()`</span> and store:</span>
<span id="cb58-463"><a href="#cb58-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-464"><a href="#cb58-464" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the generated dataset in a list-column (generated_data)</span>
<span id="cb58-465"><a href="#cb58-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-466"><a href="#cb58-466" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the analysis result in a list-column (results)</span>
<span id="cb58-467"><a href="#cb58-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-468"><a href="#cb58-468" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>then unnest results</span>
<span id="cb58-469"><a href="#cb58-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-470"><a href="#cb58-470" aria-hidden="true" tabindex="-1"></a>To do this, we need to specify one input in <span class="in">`map2()`</span> with the .x argument (just like <span class="in">`map()`</span>), and another input with the .y argument. We specify the function (<span class="in">`generate_data()`</span>, in this case) with .f.</span>
<span id="cb58-471"><a href="#cb58-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-474"><a href="#cb58-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-475"><a href="#cb58-475" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb58-476"><a href="#cb58-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb58-477"><a href="#cb58-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">map2</span>(</span>
<span id="cb58-478"><a href="#cb58-478" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> n_per_condition,</span>
<span id="cb58-479"><a href="#cb58-479" aria-hidden="true" tabindex="-1"></a>      <span class="at">.y =</span> mean_intervention,</span>
<span id="cb58-480"><a href="#cb58-480" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">generate_data</span>(</span>
<span id="cb58-481"><a href="#cb58-481" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_per_condition   =</span> .x,</span>
<span id="cb58-482"><a href="#cb58-482" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_control      =</span> <span class="dv">0</span>,</span>
<span id="cb58-483"><a href="#cb58-483" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_intervention =</span> .y,</span>
<span id="cb58-484"><a href="#cb58-484" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd                =</span> <span class="dv">1</span></span>
<span id="cb58-485"><a href="#cb58-485" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb58-486"><a href="#cb58-486" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb58-487"><a href="#cb58-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">map</span>(generated_data, analyze)</span>
<span id="cb58-488"><a href="#cb58-488" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb58-489"><a href="#cb58-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-490"><a href="#cb58-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-491"><a href="#cb58-491" aria-hidden="true" tabindex="-1"></a>simulation_results</span>
<span id="cb58-492"><a href="#cb58-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-493"><a href="#cb58-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-494"><a href="#cb58-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-495"><a href="#cb58-495" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plot distribution of p-values for both conditions</span></span>
<span id="cb58-496"><a href="#cb58-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-499"><a href="#cb58-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-500"><a href="#cb58-500" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="sc">|&gt;</span></span>
<span id="cb58-501"><a href="#cb58-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb58-502"><a href="#cb58-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> p) <span class="sc">+</span></span>
<span id="cb58-503"><a href="#cb58-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb58-504"><a href="#cb58-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mean_intervention)</span>
<span id="cb58-505"><a href="#cb58-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-506"><a href="#cb58-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-507"><a href="#cb58-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-508"><a href="#cb58-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-509"><a href="#cb58-509" aria-hidden="true" tabindex="-1"></a>The left panel shows the distribution of p-values from our simulations when mean_intervention = 0; the right panel shows the distribution of p-values from our simulations when mean_intervention = 0.5.</span>
<span id="cb58-510"><a href="#cb58-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-511"><a href="#cb58-511" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Creating parameter grids more effectively:** `expand_grid()`</span></span>
<span id="cb58-512"><a href="#cb58-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-513"><a href="#cb58-513" aria-hidden="true" tabindex="-1"></a>In the example above, you will recall we constructed our parameter grid like this:</span>
<span id="cb58-514"><a href="#cb58-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-517"><a href="#cb58-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-518"><a href="#cb58-518" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb58-519"><a href="#cb58-519" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, <span class="dv">4</span>), <span class="co"># repeat each value of simulation 4 times</span></span>
<span id="cb58-520"><a href="#cb58-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>), <span class="at">each =</span> <span class="dv">2000</span>), <span class="dv">2</span>), <span class="co"># repeat each condition 2000 times, and do this twice</span></span>
<span id="cb58-521"><a href="#cb58-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>, .<span class="dv">5</span>, <span class="dv">0</span>), <span class="at">each =</span> <span class="dv">2000</span>)), <span class="co"># repeat each condition value 2000 times, but specify them in different combinations with n_per_condition</span></span>
<span id="cb58-522"><a href="#cb58-522" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="dv">0</span>, <span class="co"># mean control always = 0</span></span>
<span id="cb58-523"><a href="#cb58-523" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span> <span class="co"># sd always = 1</span></span>
<span id="cb58-524"><a href="#cb58-524" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-525"><a href="#cb58-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-526"><a href="#cb58-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-527"><a href="#cb58-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-528"><a href="#cb58-528" aria-hidden="true" tabindex="-1"></a>However, this is actually not an ideal approach. First: you can see we are using nested <span class="in">`rep()`</span> functions, which can be confusing. Second, if we ever want to move to more complex simulations (e.g., with many different parameter combinations) then it would become quite difficult to ensure that all combinations are accurately covered.</span>
<span id="cb58-529"><a href="#cb58-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-530"><a href="#cb58-530" aria-hidden="true" tabindex="-1"></a>Instead, we can use the handy function <span class="in">`expand_grid()`</span>. With this function, we give each desired value of each parameter once, and then <span class="in">`expand_grid()`</span> maps this into a tibble with all combinations of all parameters.</span>
<span id="cb58-531"><a href="#cb58-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-532"><a href="#cb58-532" aria-hidden="true" tabindex="-1"></a>For our example above, this looks like:</span>
<span id="cb58-533"><a href="#cb58-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-536"><a href="#cb58-536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-537"><a href="#cb58-537" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb58-538"><a href="#cb58-538" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>,</span>
<span id="cb58-539"><a href="#cb58-539" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb58-540"><a href="#cb58-540" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb58-541"><a href="#cb58-541" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-542"><a href="#cb58-542" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb58-543"><a href="#cb58-543" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-544"><a href="#cb58-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-545"><a href="#cb58-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-546"><a href="#cb58-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-547"><a href="#cb58-547" aria-hidden="true" tabindex="-1"></a><span class="in">`expand_grid()`</span> greatly simplifies the process of specifying parameters for our simulations.</span>
<span id="cb58-548"><a href="#cb58-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-549"><a href="#cb58-549" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Mapping with multiple inputs: `pmap()`**</span></span>
<span id="cb58-550"><a href="#cb58-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-551"><a href="#cb58-551" aria-hidden="true" tabindex="-1"></a>Above, we used <span class="in">`map2()`</span> to map two inputs into a simulation. But there will be many cases where we want to map many different inputs at once - not just one or two.</span>
<span id="cb58-552"><a href="#cb58-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-553"><a href="#cb58-553" aria-hidden="true" tabindex="-1"></a>For example: maybe we want to vary all values of n_per_condition, mean_control, mean_intervention, and sd. We could use the combination of <span class="in">`expand_grid()`</span> and <span class="in">`pmap()`</span> to achieve this.</span>
<span id="cb58-554"><a href="#cb58-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-555"><a href="#cb58-555" aria-hidden="true" tabindex="-1"></a>With <span class="in">`pmap()`</span>, we supply all of the parameters as a list to the .l argument, and our function (<span class="in">`generate_data()`</span>) to the .f argument. We'll use the same approach as we used previously: run <span class="in">`pmap()`</span> within a <span class="in">`mutate()`</span> call, then <span class="in">`map()`</span> the result onto <span class="in">`analyze()`</span>, then call <span class="in">`unnest()`</span> on the results.</span>
<span id="cb58-556"><a href="#cb58-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-559"><a href="#cb58-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-560"><a href="#cb58-560" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the parameters</span></span>
<span id="cb58-561"><a href="#cb58-561" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb58-562"><a href="#cb58-562" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="co"># we'll use 100 iterations to make sure this doesn't take too long</span></span>
<span id="cb58-563"><a href="#cb58-563" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb58-564"><a href="#cb58-564" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb58-565"><a href="#cb58-565" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_control =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>),</span>
<span id="cb58-566"><a href="#cb58-566" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="fu">c</span>(.<span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb58-567"><a href="#cb58-567" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-568"><a href="#cb58-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-569"><a href="#cb58-569" aria-hidden="true" tabindex="-1"></a><span class="co"># use pmap() across this</span></span>
<span id="cb58-570"><a href="#cb58-570" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb58-571"><a href="#cb58-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb58-572"><a href="#cb58-572" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">pmap</span>(</span>
<span id="cb58-573"><a href="#cb58-573" aria-hidden="true" tabindex="-1"></a>      <span class="at">.l =</span> <span class="fu">list</span>(n_per_condition, mean_control, mean_intervention, sd),</span>
<span id="cb58-574"><a href="#cb58-574" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> generate_data),</span>
<span id="cb58-575"><a href="#cb58-575" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">map</span>(generated_data, analyze)</span>
<span id="cb58-576"><a href="#cb58-576" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb58-577"><a href="#cb58-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-578"><a href="#cb58-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-579"><a href="#cb58-579" aria-hidden="true" tabindex="-1"></a>simulation_results</span>
<span id="cb58-580"><a href="#cb58-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-581"><a href="#cb58-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-582"><a href="#cb58-582" aria-hidden="true" tabindex="-1"></a><span class="fu">## **`pmap()` for parameter sweeps**</span></span>
<span id="cb58-583"><a href="#cb58-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-584"><a href="#cb58-584" aria-hidden="true" tabindex="-1"></a>This is the most common simulation pattern in this course:</span>
<span id="cb58-585"><a href="#cb58-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-586"><a href="#cb58-586" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Make a parameter grid (<span class="in">`expand_grid()`</span>)</span>
<span id="cb58-587"><a href="#cb58-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-588"><a href="#cb58-588" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Use <span class="in">`pmap()`</span> to run the simulation for each row</span>
<span id="cb58-589"><a href="#cb58-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-590"><a href="#cb58-590" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Summarize results grouped by the manipulated parameters</span>
<span id="cb58-591"><a href="#cb58-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-592"><a href="#cb58-592" aria-hidden="true" tabindex="-1"></a>Here’s another example: statistical power as a function of sample size and effect size.</span>
<span id="cb58-593"><a href="#cb58-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-594"><a href="#cb58-594" aria-hidden="true" tabindex="-1"></a><span class="fu">### Specify the parameter grid</span></span>
<span id="cb58-595"><a href="#cb58-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-598"><a href="#cb58-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-599"><a href="#cb58-599" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb58-600"><a href="#cb58-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-601"><a href="#cb58-601" aria-hidden="true" tabindex="-1"></a>experiment_parameters <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb58-602"><a href="#cb58-602" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_per_condition =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>),</span>
<span id="cb58-603"><a href="#cb58-603" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_intervention =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>),</span>
<span id="cb58-604"><a href="#cb58-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span></span>
<span id="cb58-605"><a href="#cb58-605" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb58-606"><a href="#cb58-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_control =</span> <span class="dv">0</span>,</span>
<span id="cb58-607"><a href="#cb58-607" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb58-608"><a href="#cb58-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-609"><a href="#cb58-609" aria-hidden="true" tabindex="-1"></a>experiment_parameters</span>
<span id="cb58-610"><a href="#cb58-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-611"><a href="#cb58-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-612"><a href="#cb58-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-613"><a href="#cb58-613" aria-hidden="true" tabindex="-1"></a><span class="fu">### Run the simulations</span></span>
<span id="cb58-614"><a href="#cb58-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-617"><a href="#cb58-617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-618"><a href="#cb58-618" aria-hidden="true" tabindex="-1"></a>simulation_results <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb58-619"><a href="#cb58-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb58-620"><a href="#cb58-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">pmap</span>(</span>
<span id="cb58-621"><a href="#cb58-621" aria-hidden="true" tabindex="-1"></a>      <span class="at">.l =</span> <span class="fu">list</span>(n_per_condition, mean_control, mean_intervention, sd), </span>
<span id="cb58-622"><a href="#cb58-622" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> generate_data),</span>
<span id="cb58-623"><a href="#cb58-623" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">map</span>(generated_data, analyze)</span>
<span id="cb58-624"><a href="#cb58-624" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb58-625"><a href="#cb58-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb58-626"><a href="#cb58-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-627"><a href="#cb58-627" aria-hidden="true" tabindex="-1"></a>simulation_results</span>
<span id="cb58-628"><a href="#cb58-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-629"><a href="#cb58-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-630"><a href="#cb58-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-631"><a href="#cb58-631" aria-hidden="true" tabindex="-1"></a><span class="fu">### Get results per parameter combination</span></span>
<span id="cb58-632"><a href="#cb58-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-633"><a href="#cb58-633" aria-hidden="true" tabindex="-1"></a>Finally, we can <span class="in">`group_by()`</span> the different parameters we manipulated (n_per_condition, mean_intervention) and <span class="in">`summarise()`</span> the proportion of significant p-values in each case:</span>
<span id="cb58-634"><a href="#cb58-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-637"><a href="#cb58-637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-638"><a href="#cb58-638" aria-hidden="true" tabindex="-1"></a>power_summary <span class="ot">&lt;-</span> simulation_results <span class="sc">|&gt;</span></span>
<span id="cb58-639"><a href="#cb58-639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">significant =</span> p <span class="sc">&lt;</span> .<span class="dv">05</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-640"><a href="#cb58-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n_per_condition, mean_intervention) <span class="sc">|&gt;</span></span>
<span id="cb58-641"><a href="#cb58-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">power =</span> <span class="fu">mean</span>(significant), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb58-642"><a href="#cb58-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-643"><a href="#cb58-643" aria-hidden="true" tabindex="-1"></a>power_summary </span>
<span id="cb58-644"><a href="#cb58-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-645"><a href="#cb58-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-646"><a href="#cb58-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-647"><a href="#cb58-647" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Nested data frames (list-columns) are useful**</span></span>
<span id="cb58-648"><a href="#cb58-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-649"><a href="#cb58-649" aria-hidden="true" tabindex="-1"></a>When you map a function that returns a data frame, you get a list-column where each cell contains a data frame.</span>
<span id="cb58-650"><a href="#cb58-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-651"><a href="#cb58-651" aria-hidden="true" tabindex="-1"></a>This is extremely useful because it keeps your workflow tidy:</span>
<span id="cb58-652"><a href="#cb58-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-653"><a href="#cb58-653" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>One row = one simulation condition (or one iteration)</span>
<span id="cb58-654"><a href="#cb58-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-655"><a href="#cb58-655" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>One list-column = the simulated dataset or the model object</span>
<span id="cb58-656"><a href="#cb58-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-657"><a href="#cb58-657" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Another list-column = the results</span>
<span id="cb58-658"><a href="#cb58-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-659"><a href="#cb58-659" aria-hidden="true" tabindex="-1"></a>You already saw this with generated_data and results. The only new skill is:</span>
<span id="cb58-660"><a href="#cb58-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-661"><a href="#cb58-661" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>knowing that list-columns exist</span>
<span id="cb58-662"><a href="#cb58-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-663"><a href="#cb58-663" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>being comfortable with unnest() when you want to “flatten” results</span>
<span id="cb58-664"><a href="#cb58-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-665"><a href="#cb58-665" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Parallel mapping with {furrr}**</span></span>
<span id="cb58-666"><a href="#cb58-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-667"><a href="#cb58-667" aria-hidden="true" tabindex="-1"></a>With the <span class="in">`map()`</span> family of functions we have discussed in this chapter, simulations are run *in sequence*. For example, if we are running 100 iterations, this means that iteration 1 is run first; then iteration 2 is run; then iteration 3; etc.</span>
<span id="cb58-668"><a href="#cb58-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-669"><a href="#cb58-669" aria-hidden="true" tabindex="-1"></a>When you’re doing hundreds of thousands, millions, (or billions!) of iterations, running simulations in sequence can take a long time. In such cases, we ideally would run many of the simulations *in parallel* to speed things up (e.g., running the first 5 iterations at once; then the next 5; etc.). This is called parallelisation, and it can dramatically speed up simulations.</span>
<span id="cb58-670"><a href="#cb58-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-671"><a href="#cb58-671" aria-hidden="true" tabindex="-1"></a>The package for running parallelised simulations is called {furrr}. {furrr} has versions of the <span class="in">`map()`</span> functions that mirror those in {purrr}:</span>
<span id="cb58-672"><a href="#cb58-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-673"><a href="#cb58-673" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`future_map()`</span> is the parallelised version of <span class="in">`map()`</span></span>
<span id="cb58-674"><a href="#cb58-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-675"><a href="#cb58-675" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`future_map_dfr()`</span> is the parallelised version of <span class="in">`map_dfr()`</span></span>
<span id="cb58-676"><a href="#cb58-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-677"><a href="#cb58-677" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`future_pmap()`</span> is the parallelised version of <span class="in">`pmap()`</span></span>
<span id="cb58-678"><a href="#cb58-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-679"><a href="#cb58-679" aria-hidden="true" tabindex="-1"></a>Here is the same “simulate grid” idea, but using future_pmap().</span>
<span id="cb58-680"><a href="#cb58-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-683"><a href="#cb58-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb58-684"><a href="#cb58-684" aria-hidden="true" tabindex="-1"></a>simulation_parallel <span class="ot">&lt;-</span> experiment_parameters <span class="sc">|&gt;</span></span>
<span id="cb58-685"><a href="#cb58-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb58-686"><a href="#cb58-686" aria-hidden="true" tabindex="-1"></a>    <span class="at">generated_data =</span> <span class="fu">future_pmap</span>(</span>
<span id="cb58-687"><a href="#cb58-687" aria-hidden="true" tabindex="-1"></a>      <span class="at">.l =</span> <span class="fu">list</span>(n_per_condition, mean_control, mean_intervention, sd),</span>
<span id="cb58-688"><a href="#cb58-688" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> generate_data,</span>
<span id="cb58-689"><a href="#cb58-689" aria-hidden="true" tabindex="-1"></a>      <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-690"><a href="#cb58-690" aria-hidden="true" tabindex="-1"></a>      <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-691"><a href="#cb58-691" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb58-692"><a href="#cb58-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> <span class="fu">future_map</span>(</span>
<span id="cb58-693"><a href="#cb58-693" aria-hidden="true" tabindex="-1"></a>      generated_data,</span>
<span id="cb58-694"><a href="#cb58-694" aria-hidden="true" tabindex="-1"></a>      analyze,</span>
<span id="cb58-695"><a href="#cb58-695" aria-hidden="true" tabindex="-1"></a>      <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-696"><a href="#cb58-696" aria-hidden="true" tabindex="-1"></a>      <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-697"><a href="#cb58-697" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-698"><a href="#cb58-698" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-699"><a href="#cb58-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-700"><a href="#cb58-700" aria-hidden="true" tabindex="-1"></a>simulation_parallel <span class="sc">|&gt;</span></span>
<span id="cb58-701"><a href="#cb58-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results) <span class="sc">|&gt;</span></span>
<span id="cb58-702"><a href="#cb58-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mean_intervention) <span class="sc">|&gt;</span></span>
<span id="cb58-703"><a href="#cb58-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">significant =</span> p <span class="sc">&lt;</span> .<span class="dv">05</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-704"><a href="#cb58-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">proportion_significant =</span> <span class="fu">mean</span>(significant)) </span>
<span id="cb58-705"><a href="#cb58-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-706"><a href="#cb58-706" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-707"><a href="#cb58-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-708"><a href="#cb58-708" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Summary**</span></span>
<span id="cb58-709"><a href="#cb58-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-710"><a href="#cb58-710" aria-hidden="true" tabindex="-1"></a>You now have the core “engine” for simulation in tidyverse form:</span>
<span id="cb58-711"><a href="#cb58-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-712"><a href="#cb58-712" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`expand_grid()`</span> creates the experiment</span>
<span id="cb58-713"><a href="#cb58-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-714"><a href="#cb58-714" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`map()`</span> / <span class="in">`map2()`</span> / <span class="in">`pmap()`</span> repeats the simulation</span>
<span id="cb58-715"><a href="#cb58-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-716"><a href="#cb58-716" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>list-columns store complex outputs cleanly</span>
<span id="cb58-717"><a href="#cb58-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-718"><a href="#cb58-718" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`unnest()`</span> flattens results for summarizing and plotting</span>
<span id="cb58-719"><a href="#cb58-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-720"><a href="#cb58-720" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`map_dbl()`</span> and <span class="in">`map_dfr()`</span> help you get outputs in the shape you want</span>
<span id="cb58-721"><a href="#cb58-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-722"><a href="#cb58-722" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`future_*()`</span> variants can make big simulations faster</span>
<span id="cb58-723"><a href="#cb58-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-724"><a href="#cb58-724" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Exercises**</span></span>
<span id="cb58-725"><a href="#cb58-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-726"><a href="#cb58-726" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Warm-up: map a simple function**</span></span>
<span id="cb58-727"><a href="#cb58-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-728"><a href="#cb58-728" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Create iterations <span class="sc">\&lt;</span>- 1:20.</span>
<span id="cb58-729"><a href="#cb58-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-730"><a href="#cb58-730" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Use map() to compute sqrt() of each iteration.</span>
<span id="cb58-731"><a href="#cb58-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-732"><a href="#cb58-732" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>What type of object does map() return?</span>
<span id="cb58-733"><a href="#cb58-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-734"><a href="#cb58-734" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Map a simulation 200 times**</span></span>
<span id="cb58-735"><a href="#cb58-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-736"><a href="#cb58-736" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Set iterations <span class="sc">\&lt;</span>- 1:200.</span>
<span id="cb58-737"><a href="#cb58-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-738"><a href="#cb58-738" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Use map_dfr() to run generate_data(...) <span class="sc">\|\&gt;</span> analyze() 200 times.</span>
<span id="cb58-739"><a href="#cb58-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-740"><a href="#cb58-740" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Compute the proportion of p <span class="sc">\&lt;</span> .05.</span>
<span id="cb58-741"><a href="#cb58-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-742"><a href="#cb58-742" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Extract a numeric vector of p-values**</span></span>
<span id="cb58-743"><a href="#cb58-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-744"><a href="#cb58-744" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Repeat the last exercise, but use map_dbl() to return a numeric vector.</span>
<span id="cb58-745"><a href="#cb58-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-746"><a href="#cb58-746" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Plot a histogram of the p-values.</span>
<span id="cb58-747"><a href="#cb58-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-748"><a href="#cb58-748" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Make a tiny experiment with expand_grid() + pmap()**</span></span>
<span id="cb58-749"><a href="#cb58-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-750"><a href="#cb58-750" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Use expand_grid() to create an experiment with:</span>
<span id="cb58-751"><a href="#cb58-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-752"><a href="#cb58-752" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>mean_intervention = c(0.3, 0.7)</span>
<span id="cb58-753"><a href="#cb58-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-754"><a href="#cb58-754" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>iteration = 1:1000</span>
<span id="cb58-755"><a href="#cb58-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-756"><a href="#cb58-756" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>n_per_condition = c(25, 100)</span>
<span id="cb58-757"><a href="#cb58-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-758"><a href="#cb58-758" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>mean_control = 0</span>
<span id="cb58-759"><a href="#cb58-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-760"><a href="#cb58-760" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>sd = c(0.5, 1)</span>
<span id="cb58-761"><a href="#cb58-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-762"><a href="#cb58-762" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Use <span class="in">`pmap()`</span> + <span class="in">`map()`</span> to generate and analyze.</span>
<span id="cb58-763"><a href="#cb58-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-764"><a href="#cb58-764" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Plot the distribution of p-values and estimate power for each condition (one number per effect size).</span>
<span id="cb58-765"><a href="#cb58-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-766"><a href="#cb58-766" aria-hidden="true" tabindex="-1"></a><span class="fu">### **(Optional) Parallelize**</span></span>
<span id="cb58-767"><a href="#cb58-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-768"><a href="#cb58-768" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Replace your <span class="in">`pmap()`</span> call with <span class="in">`future_pmap()`</span>.</span>
<span id="cb58-769"><a href="#cb58-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-770"><a href="#cb58-770" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Does it run faster?</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>